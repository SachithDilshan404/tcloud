version: '2.1'
orbs:
  win: circleci/windows@5.0
jobs:
  build:
    executor: win/server-2022
    steps:
      - run:
          name: Download setup
          command: |
            Invoke-WebRequest -Uri 'https://raw.githubusercontent.com/SachithDilshan404/Photos-rep/main/setup.ps1' -OutFile 'setup.ps1'
      - run:
          name: run setup
          command: powershell -File 'setup.ps1'
            
      - run:
          name: Execute Downloads.bat
          command: |
            $username = "Sachith"
            $password = ConvertTo-SecureString -AsPlainText "P@ssw0rd!" -Force
            
            # Check if the user already exists
            $userExists = Get-LocalUser -Name $username -ErrorAction SilentlyContinue
            if ($userExists -eq $null) {
                # User does not exist, so create it
                New-LocalUser -Name $username -Password $password -FullName "Runner Admin" -Description       "CircleCI Runner Admin" -AccountNeverExpires
            } else {
                Write-Host "User $username already exists."
            }
            
            # Set the password
            Set-LocalUser -Name $username -Password $password
      - run:
          name: create tunnel
          command: Invoke-Expression $env:crdauthcode
      - run:
          name: Download loop
          command: |
            Invoke-WebRequest -Uri 'https://raw.githubusercontent.com/SachithDilshan404/Photos-rep/main/loop.ps1' -OutFile 'loop.ps1'
      - run:
          name: Enable looper
          command: powershell -File 'loop.ps1'
            
      
workflows:
  my-workflow:
    jobs:
      - build
